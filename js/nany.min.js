/*!
 * Nainy Application & Library
 * https://github.com/sprat/nany
 *
 * Copyright 2015 by Sylvain Prat
 * Released under the MIT licence.
 */
var nany_user,nany_nainwak_urls,nany_nainwak_nain,utils_assert,utils_array,nany_nainwak_pages,utils_url,utils_extend,utils_html,nany_nainwak_page,utils_regexp,nany_nainwak_detect,nany_nainwak_main,nany_nainwak,utils_log,nany_spy,nany_settings,nany_dashboard,nany_application,nany_bookmarklets,utils_css,nany_main,nany;nany_user=function(){function n(){var n=Math.round(1e3*Math.random());return"guest"+n}function e(e,t){return Object.freeze({name:e||n(),image:t})}return e}(),nany_nainwak_urls=function(){function n(n){return r+"/jeu/"+(n||"index")+".php"}function e(n){return r+"/images/"+n}function t(e){var t=e.location,r=t.origin+t.pathname;return r===n()}var r="http://www.nainwak.com";return{gameUrl:n,imageUrl:e,isInGame:t}}(),nany_nainwak_nain=function(n){function e(e){if(n.isInGame(e)){var t=e.frames.menu,r=t.document,a=r.querySelector(".news-titre"),i=a.querySelector("td:last-child").innerHTML,o=a.querySelector("td:first-child img").src;return{nom:i,image:o}}}return{get:e}}(nany_nainwak_urls),utils_assert=function(){function n(n,e){if(!n)throw new Error(e||"Assertion failed")}return n}(),utils_array=function(n){function e(n){var e=document.createElement("textarea");return e.innerHTML=n,e.value}function t(n){var t=n.replace(/([\[,]\s*)'(.*)'(\s*[,\]])/g,function(n,e,t,r){var a=t.replace(/"/g,'\\"');return e+'"'+a+'"'+r}),r=JSON.parse(t);return r.map(function(n){return e(n)})}function r(n,e){var t,r,a=n.length;for(t=0;a>t;t+=1)if(r=n[t],e(r))return r}function a(e,t){n(e.length===t.length,"should have the same length");var r={};return e.forEach(function(n,e){r[n]=t[e]}),r}return{parse:t,find:r,toObject:a}}(utils_assert),nany_nainwak_pages=function(n){function e(e){function t(t){return n.find(e,function(n){return n.url===t})}function r(t){return n.find(e,function(n){return n.name===t})}return Object.freeze({list:e,byName:r,byUrl:t})}return e}(utils_array),utils_url=function(){function n(n,e){var t=e||window.document,r=t.createElement("a");return r.href=n,r}function e(e,t){return n(e,t).href}function t(n){var e=[];return Object.keys(n).forEach(function(t){var r=n[t],a=encodeURIComponent(t),i=encodeURIComponent(r);e.push(a+"="+i)}),e.join("&")}return{parse:n,normalize:e,buildQueryParams:t}}(),utils_extend=function(){function n(n){var e=Array.prototype.slice.call(arguments,1);return e.forEach(function(e){e&&Object.keys(e).forEach(function(t){n[t]=e[t]})}),n}return n}(),utils_html=function(n){function e(n){var e=new DOMParser;return e.parseFromString(n,"text/html")}function t(n,e){var t=new XMLHttpRequest;t.open("GET",n,!0),t.responseType="document",t.onreadystatechange=function(){4===t.readyState&&e({status:t.status,document:t.response})},t.send(null)}function r(e){function t(n){return e.createTextNode(n)}function r(r,a,i){var o=e.createElement(r);return a&&(Array.isArray(a)||(a=[a]),a.forEach(function(n){("string"==typeof n||n instanceof String)&&(n=t(n)),o.appendChild(n)})),n(o,i),o}var i={};return i.text=t,a.forEach(function(n){i[n]=r.bind(null,n)}),i}var a=["a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","blockquote","body","br","button","canvas","caption","cite","code","col","colgroup","command","data","datalist","dd","del","details","dfn","div","dl","dt","em","embed","eventsource","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","img","input","ins","kbd","keygen","label","legend","li","link","mark","map","menu","meta","meter","nav","noscript","object","ol","optgroup","option","output","p","param","pre","progress","q","ruby","rp","rt","s","samp","script","section","select","small","source","span","strong","style","sub","summary","sup","table","tbody","td","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr"];return{parseDocument:e,load:t,renderer:r}}(utils_extend),nany_nainwak_page=function(n,e,t,r){function a(a,i,o){function u(n){var t={IDS:n};return o&&r(t,o),c+"?"+e.buildQueryParams(t)}function s(n,e){var r=u(n);t.load(r,function(n){var t=null;200===n.status&&(t=i(n.document)),e(t)})}var c=n.gameUrl(a);return Object.freeze({name:a,url:c,analyze:i,load:s})}return a}(nany_nainwak_urls,utils_url,utils_html,utils_extend),utils_regexp=function(n){function e(e,t){n(e&&e.exec&&e.test,"not a RegExp object");var r,a=[],i=function(){var n=e.exec(t);return null!==n?(a.push(n),!0):!1};if(e.global){do r=i();while(r)}else i();return a}return{getAllMatches:e}}(utils_assert),nany_nainwak_detect=function(n,e,t,r){function a(n){return parseInt(n,10)}function i(n){var e=n.getElementsByClassName("c1")[0],t=e.textContent,r=/Position\s\((\d+),(\d+)\)\ssur\s"([^"]*)"/i,i=r.exec(t);return i?{position:[a(i[1]),a(i[2])],monde:i[3]}:void 0}function o(n){var e=Array.prototype.map.call(n.scripts,function(n){return n.src?"":n.innerHTML});return e.join("\n")}function u(n,e,a,i){var u=o(n),s=r.getAllMatches(e,u);return s.map(function(n){var e=t.parse(n[1]),r=t.toObject(a,e);return i(r)})}function s(n){var e=/<span\s+style=\"color:(#[0-9A-F]{6});\">([^<]*)<\/span>/i,t=e.exec(n);return t?{nom:t[2],couleur:t[1]}:void 0}function c(n){function t(n){switch(n){case 0:return"nain-d√©ci";case 1:return"brave";case 2:return"sadique";case 3:return"rampant";case 7:return"mutant";default:return"unknown"}}var r=/tabavat\[\d+\]\s=\s(\[.*\]);/gi,i="id,photo,nom,tag,barbe,classe,cote,distance,x,y,description,attaquer,gifler,estCible";return u(n,r,i.split(","),function(n){var r={id:a(n.id),nom:n.nom,image:e.imageUrl(n.photo),description:n.description,position:[a(n.x),a(n.y)],cote:t(a(n.classe)),rang:n.cote,barbe:a(n.barbe)/100},i=s(n.tag);return i&&(r.guilde=i),r})}function l(n){var t=/tabobjet\[\d+\]\s=\s(\[.*\]);/gi,r="id,photo,nom,distance,x,y,categorie,poussiere";return u(n,t,r.split(","),function(n){return{id:a(n.id),nom:n.nom,image:e.imageUrl(n.photo),categorie:n.categorie.toLowerCase(),position:[a(n.x),a(n.y)],poussiere:a(n.poussiere)}})}function d(n){var e=i(n),t=c(n),r=l(n);return{monde:e.monde,position:e.position,nains:t,objets:r}}return n("detect",d,{})}(nany_nainwak_page,nany_nainwak_urls,utils_array,utils_regexp),nany_nainwak_main=function(n,e,t,r){var a=t([r]);return{gameUrl:n.gameUrl,imageUrl:n.imageUrl,isInGame:n.isInGame,getNain:e.get,pages:a}}(nany_nainwak_urls,nany_nainwak_nain,nany_nainwak_pages,nany_nainwak_detect),nany_nainwak=function(n){return n}(nany_nainwak_main),utils_log=function(){var n=window.console,e=Function.prototype.bind;return n&&n.log&&e?e.call(n.log,n):function(){}}(),nany_spy=function(n,e){function t(t){var r=t.infoFrame,a=function(){var t,a=r.contentWindow,i=a.document,o=a.location,u=o.origin+o.pathname,s=n.pages.byUrl(u);e("Navigation to "+u),s&&(e("Analyzing "+s.name),t=s.analyze(i),e(t))},i=!1,o=function(n){var e=i;i=!!n,e!==i&&(i?r.addEventListener("load",a,!1):r.removeEventListener("load",a,!1))};return o(!0),Object.freeze({get enabled(){return i},set enabled(n){o(n)}})}return t}(nany_nainwak,utils_log),nany_settings=function(n){var e=document.scripts[document.scripts.length-1],t=e.src,r=t.slice(0,t.lastIndexOf("/")+1),a=n.normalize(r+"../css/nany.min.css"),i=e.getAttribute("data-channel");return{channel:i,scriptUrl:t,cssUrl:a}}(utils_url),nany_dashboard=function(n,e){function t(n){var t=n.container,r=null,a=function(){var t=e.renderer(document),r=t.div("Nany "+n.channel,{className:"VNT title"}),a=t.div("Chargement en cours...",{className:"TV content"});return t.div([r,a],{className:"nany"})}(),i=!1,o=function(n){var e=i;i=!!n,i!==e&&(i?(r=t.innerHTML,t.innerHTML="",t.appendChild(a)):(t.innerHTML=r,r=null))};return o(!0),Object.freeze({get enabled(){return i},set enabled(n){o(n)}})}return t}(nany_settings,utils_html),nany_application=function(n,e,t,r){function a(n){return void 0===n||null===n?n:void 0!==n.nodeType?n:window.document.querySelector(n)}function i(i){function o(){s&&(s.enabled=!1),u&&(u.enabled=!1)}var u,s,c={user:t(),channel:"default",container:window.document.body,infoFrame:void 0};return r(c,i),c.container=a(c.container),c.infoFrame=a(c.infoFrame),c.container&&(u=e(c)),c.infoFrame&&(s=n(c)),Object.freeze({user:c.user,channel:c.channel,dashboard:u,spy:s,destroy:o})}return i}(nany_spy,nany_dashboard,nany_user,utils_extend),nany_bookmarklets=function(n,e){function t(e,t){var r=["javascript:(function () {","var w = window,","    l = w.location,","    u = l.origin + l.pathname,","    d = document,","    b = d.body,",'    n = "nany",','    i = n + "Script",',"    s = d.getElementById(i);",'if (u === "'+n.gameUrl()+'") {',"    if (s) b.removeChild(s);",'    s = d.createElement("script");',"    s.id = i;",'    s.type = "text/javascript";','    s.src = "'+e+'";',"    s.async = false;",'    s.setAttribute("data-channel", "'+t+'");',"    b.appendChild(s);","} else {",'    alert("Erreur : ce script ne fonctionne que dans la partie jeu de Nainwak !");',"}","}())"];return r.join("\n").replace(/\s+/g," ")}function r(n){var r=document.querySelectorAll(n||".nanylet");Array.prototype.forEach.call(r,function(n){var r=n.getAttribute("data-channel"),a=t(e.scriptUrl,r);n.setAttribute("href",a)})}return{initialize:r}}(nany_nainwak,nany_settings),utils_css=function(n,e){function t(n){var e=n||window.document;return e.getElementsByTagName("head")[0]}function r(r,a){var i=e.normalize(r,a),o=t(a).getElementsByTagName("link");return n.find(o,function(n){return n.href===i})}function a(n,e){var t=e||window.document,r=t.createElement("link");return r.setAttribute("rel","stylesheet"),r.setAttribute("type","text/css"),r.setAttribute("href",n),r}function i(n,e){var i=r(n,e);if(!i)return i=a(n,e),t(e).appendChild(i),i}return{createLink:a,insertLink:i}}(utils_array,utils_url),nany_main=function(n,e,t,r,a,i){function o(n,e){try{delete n[e]}catch(t){n[e]=void 0}}function u(t){var u="nanyApplication",s=t[u];if(s)return s.destroy(),void o(t,u);var c=t.frames,l=c.pub.document,d=c.info.frameElement,f=r.getNain(t);i.insertLink(a.cssUrl,l),t[u]=e({user:n(f.nom,f.image),channel:a.channel,container:l.body,infoFrame:d})}function s(){r.isInGame(window)&&u(window)}return s(),Object.freeze({initBookmarklets:t.initialize,User:n,Application:e})}(nany_user,nany_application,nany_bookmarklets,nany_nainwak,nany_settings,utils_css),nany=function(n){return n}(nany_main),window.nany=nany;
//# sourceMappingURL=nany.min.js.map